<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>OIDC Wrapper App</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: 24px auto; padding: 0 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 14px 0; }
    label { display: inline-block; min-width: 90px; }
    input[type="text"] { width: 240px; padding: 6px; }
    textarea { width: 100%; height: 120px; padding: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    button { padding: 8px 12px; }
    pre { white-space: pre-wrap; word-break: break-word; background: #f7f7f7; padding: 10px; border-radius: 8px; }
    .muted { color: #666; font-size: 0.95em; }
  </style>
</head>
<body>
  <h1>OIDC Wrapper Web App</h1>

  <div class="card">
    <div class="row">
      <button onclick="login()">Login (Keycloak)</button>
      <button onclick="callApi()">Call Protected API (Keycloak token)</button>
    </div>
    <p class="muted">
    </p>
  </div>

  <div class="card">
    <h2>Dev JWT（Issuer未確定の間の疎通確認用）</h2>

    <div class="row" style="margin-bottom: 10px;">
      <div>
        <label>username</label>
        <input id="devUsername" type="text" value="testuser" />
      </div>
      <div>
        <label>password</label>
+       <input id="devPassword" type="text" value="password" />
      </div>

      <button onclick="createDevJwt()">JWTを作成（/api/auth/login）</button>
      <button onclick="verifyJwt()">入力JWTを検証（/api/protected/）</button>
      <button onclick="clearResult()">表示をクリア</button>
    </div>

    <div style="margin-bottom: 8px;">
      <label style="min-width:auto;">JWT（Bearer なしで貼ってOK）</label>
    </div>
    <textarea id="jwtInput" placeholder="ここにJWTを貼る（Bearer は不要）"></textarea>

    <p class="muted">
      「JWTを作成」はバックエンドが ENABLE_DEV_LOGIN=true のときだけ使えます。<br>
      「検証」は入力JWTで /api/protected/ を叩き、200ならOK、401ならNG（署名/期限/形式など）です。
    </p>
  </div>

  <h2>結果</h2>
  <pre id="result"></pre>

  <script src="https://cdn.jsdelivr.net/npm/keycloak-js@25.0.1/dist/keycloak.min.js"></script>
  <script>
    const keycloak = new Keycloak({
      url: "http://153.121.75.6:8080",
      realm: "are-you-tsukuba",
      clientId: "frontend"
    });

    function log(msg) {
      const el = document.getElementById("result");
      el.textContent = (el.textContent ? (el.textContent + "\n") : "") + msg;
    }

    function clearResult() {
      document.getElementById("result").textContent = "";
    }

    async function login() {
      await keycloak.init({
        onLoad: 'login-required',
        checkLoginIframe: false,
        pkceMethod: 'S256',
        flow: 'standard'
      });
      if (!keycloak.authenticated) keycloak.login();
      log("[Keycloak] authenticated=" + keycloak.authenticated);
    }

    async function callApi() {
      try {
        if (!keycloak.token) {
          log("[Keycloak] token がありません。Login を先に押してください。");
          return;
        }
        const res = await fetch("/api/protected/", {
          headers: { Authorization: "Bearer " + keycloak.token }
        });
        const text = await res.text();
        log(`[Keycloak] /api/protected/ -> ${res.status}\n${text}`);
      } catch (e) {
        log("[Keycloak] error: " + String(e));
      }
    }

    // 追加：DEV JWT 作成
    async async function createDevJwt() {
  try {
    const username = document.getElementById("devUsername").value.trim() || "admin";
    const password = document.getElementById("devPassword").value.trim() || "password";

    const res = await fetch("/api/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });

    const obj = await res.json().catch(async () => ({ raw: await res.text() }));

    if (res.ok && obj && obj.access_token) {
      document.getElementById("jwtInput").value = obj.access_token;
      log(`[DEV] /api/auth/login -> ${res.status}\n(access_token を入力欄にセットしました)`);
      return;
    }

    log(`[DEV] /api/auth/login -> ${res.status}\n${JSON.stringify(obj, null, 2)}`);
  } catch (e) {
    log("[DEV] error: " + String(e));
  }
}


    // 追加：入力JWTの検証（= protected を叩く）
    async function verifyJwt() {
      try {
        const token = document.getElementById("jwtInput").value.trim();
        if (!token) {
          log("[VERIFY] JWTが空です。入力してから押してください。");
          return;
        }

        const res = await fetch("/api/protected/", {
          headers: { Authorization: "Bearer " + token }
        });
        const text = await res.text();
        log(`[VERIFY] /api/protected/ -> ${res.status}\n${text}`);
      } catch (e) {
        log("[VERIFY] error: " + String(e));
      }
    }
  </script>
</body>
</html>
