<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>OIDC Wrapper App</title>
</head>
<body>
  <h1>OIDC Wrapper Web App</h1>

  <button onclick="login()">Login</button>
  <button onclick="callApi()">Call Protected API</button>

  <pre id="result"></pre>

  <script src="https://cdn.jsdelivr.net/npm/keycloak-js@25.0.1/dist/keycloak.min.js"></script>
  <script>
    const keycloak = new Keycloak({
      url: "http://localhost:8080",
      realm: "are-you-tsukuba",
      clientId: "frontend"
    });

    async function login() {
      // onLoad: 'login-required', flow: 'standard' を指定
      await keycloak.init({
        onLoad: 'login-required',
        checkLoginIframe: false,   // iframe チェック不要
        pkceMethod: 'S256',        // 推奨PKCE
        flow: 'standard'
      });
      if (!keycloak.authenticated) {
        keycloak.login();           // 明示的にログイン呼び出し
      }
    }


    async function callApi() {
      const res = await fetch("http://localhost:8000/protected", {
        headers: {
          Authorization: "Bearer " + keycloak.token
        }
      });

      document.getElementById("result").textContent =
        await res.text();
    }
  </script>
</body>
</html>
